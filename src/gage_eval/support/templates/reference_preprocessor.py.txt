from __future__ import annotations

from typing import Any, Dict, Mapping

from gage_eval.assets.datasets.preprocessors.base import BasePreprocessor
from gage_eval.assets.datasets.utils.mapping import extract_field


class DocVQAPreprocessor(BasePreprocessor):
    """Example preprocessor demonstrating a complete Sample mapping.

    This reference implementation shows how to populate:
    - `metadata` for grouping/auditing
    - `answers` / `label` for metric compatibility
    - `messages` for chat-style backends
    """

    name = "docvqa_demo"

    def __init__(self, **kwargs: Any) -> None:
        super().__init__(**kwargs)

    def to_sample(self, record: Mapping[str, Any], **kwargs: Any) -> Dict[str, Any]:
        dataset_id = record.get("_dataset_id") or "docvqa_demo"
        question = extract_field(record, "question")
        answer = extract_field(record, "answers.0") or extract_field(record, "answer")
        if question is None or not str(question).strip():
            raise ValueError("Missing or empty 'question' field")

        sample: Dict[str, Any] = {
            "_dataset_id": dataset_id,
            "modalities": ["text"],
            "question": str(question),
            "answers": [str(answer)] if answer is not None else [],
            "messages": [
                {
                    "role": "system",
                    "content": [{"type": "text", "text": "You are a document QA assistant. Provide the final answer."}],
                },
                {
                    "role": "user",
                    "content": [{"type": "text", "text": str(question)}],
                },
            ],
        }

        # NOTE: Preserve metadata for grouping and auditing.
        meta = dict(record.get("metadata") or {})
        for key in ("doc_id", "page", "split", "unique_id"):
            if record.get(key) is not None:
                meta[key] = record.get(key)
        if sample.get("answers"):
            meta["answers"] = sample["answers"]
            sample["label"] = sample["answers"][0]
        sample["metadata"] = meta
        return sample
