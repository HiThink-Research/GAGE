{# 
  Benchmark preprocessor template.
  - This file is rendered into: src/gage_eval/assets/datasets/preprocessors/<dataset_slug>_preprocessor.py
  - Registry wrapper should be appended to preprocessors/custom.py (or _generated.py) using the snippet below.
#}

from __future__ import annotations

from typing import Any, Dict, Optional

from gage_eval.assets.datasets.preprocessors.base import BasePreprocessor
from gage_eval.assets.datasets.utils.mapping import extract_field


class {{ preprocessor_class_name }}(BasePreprocessor):
    """{{ dataset_name }} preprocessor (auto-generated; customize if needed)."""

    name = "{{ preprocess_name }}"
    modalities = {{ modalities | default("['text']") }}

    def __init__(self, tokenizer=None, tokenizer_path: Optional[str] = None, **kwargs: Any) -> None:
        super().__init__(tokenizer=tokenizer, tokenizer_path=tokenizer_path, **kwargs)

    def to_sample(self, record: Dict[str, Any], **kwargs: Any) -> Dict[str, Any]:
        merged = dict(self.kwargs)
        merged.update(kwargs)
        dataset_id = merged.pop("dataset_id", None) or record.get("_dataset_id") or "{{ dataset_id }}"
        dataset_meta = merged.pop("dataset_metadata", None) or record.get("_dataset_metadata")

        # NOTE: Build a Sample dict according to the field mapping in `design.md`
        # (yaml `support_config`). Canonical normalization is handled by BasePreprocessor.
        sample: Dict[str, Any] = {
            "_dataset_id": dataset_id,  # explicit for debug/trace
            "_dataset_metadata": dataset_meta,
            "modalities": list({{ modalities | default("['text']") }}),
            "metadata": {},
            "answers": [],
        }

{{ (to_sample_body | default("# (support) fill field mapping here")) | indent(8, true) }}

        # NOTE: Keep label/answers aligned with the default metric field paths.
        if sample.get("answers") and not sample.get("label"):
            sample["label"] = sample["answers"][0]
        return sample


__all__ = ["{{ preprocessor_class_name }}"]

{# -------------------------------------------------------------------------
Registry wrapper snippet (append to preprocessors/custom.py or _generated.py).
NOTE: registry.asset requires non-empty desc.
------------------------------------------------------------------------- #}
{# 
@registry.asset(
    "dataset_preprocessors",
    "{{ preprocess_name }}",
    desc="{{ dataset_name }} Preprocessor",
    tags={{ tags | default("()") }},
)
class {{ registry_wrapper_class_name | default(preprocessor_class_name) }}({{ preprocessor_class_name }}):
    pass
#}
