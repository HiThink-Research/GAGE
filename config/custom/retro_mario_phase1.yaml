api_version: gage/v1alpha1
kind: PipelineConfig

metadata:
  name: retro_mario_phase1
  description: Phase 1 stable-retro demo (tick scheduler + temporal abstraction).

custom:
  steps:
    - step: arena
      adapter_id: retro_mario_arena

datasets:
  - dataset_id: retro_mario_single
    loader: jsonl
    params:
      path: tests/data/Test_Retro_Mario.jsonl
      streaming: false

backends:
  - backend_id: retro_dummy_backend
    type: dummy
    config:
      responses:
        - '{"move":"right","hold_ticks":6}'
        - '{"move":"right_jump","hold_ticks":8}'
        - '{"move":"noop","hold_ticks":4}'
      cycle: true

role_adapters:
  - adapter_id: retro_dummy_model
    role_type: dut_model
    backend_id: retro_dummy_backend
    capabilities:
      - chat_completion

  - adapter_id: retro_mario_arena
    role_type: arena
    params:
      environment:
        impl: retro_env_v1
        game: ${RETRO_GAME_ID}
        state: ${RETRO_STATE:-Start}
        # NOTE: ROMs are not tracked in this repo; provide a local path if you want it recorded as metadata.
        rom_path: ${RETRO_ROM_PATH:-}
        runtime_policy: persistent
        render: true
        render_every_n_ticks: 1
        record_bk2: true
        info_feeder:
          impl: info_last_v1
        action_schema:
          hold_ticks_min: 1
          hold_ticks_max: 20
          hold_ticks_default: 6
        frame_stride: 1
        snapshot_stride: 1
      scheduler:
        type: tick
        tick_ms: 100
        max_ticks: 1800
        decision_interval: 6
        llm_wait:
          mode: wait_then_fallback
          max_wait_ms: 1500
          on_timeout: repeat_last
        control_strategy:
          name: temporal_abstraction
          params:
            hold_ticks_min: 1
            hold_ticks_max: 20
            hold_ticks_default: 6
      parser:
        impl: retro_action_v1
      players:
        - name: player_0
          player_id: player_0
          type: backend
          ref: retro_dummy_model
          max_retries: 0
          fallback_policy: first_legal

tasks:
  - task_id: retro_mario_phase1_demo
    dataset_id: retro_mario_single
    max_samples: 1
    concurrency: 1
    reporting:
      sinks:
        - type: console
        - type: file
          params:
            output_path: ${GAGE_EVAL_SAVE_DIR:-./runs}/retro_mario_phase1_events.jsonl
