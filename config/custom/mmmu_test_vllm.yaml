api_version: gage/v1alpha1
kind: PipelineConfig
metadata:
  name: mmmu_legacy_vllm
  description: 多模态基准，使用 vllm_backend（本地 AsyncLLMEngine）评测 MMMU val500，参考 mmmu_local_vlm。

custom:
  steps:
    - step: inference
    - step: auto_eval

datasets:
  - dataset_id: mmmu_val_local
    loader: jsonl
    params:
      path: /mnt/aime_data_ssd/user_workspace/zhuwenqiao/hub/cmp/lmms-lab/MMMU/data/mmmu_val_500.jsonl
      doc_to_visual: gage_eval.assets.datasets.utils.multimodal:embed_local_message_images
      doc_to_visual_kwargs:
        content_field: messages.0.content

backends:
  - backend_id: mmmu_legacy_vllm_backend
    type: vllm
    config:
      model_path: /mnt/model/qwen2_5_vl_3b  # 多模态模型路径，需支持 vision
      tokenizer_path: /mnt/model/qwen2_5_vl_3b
      tensor_parallel_size: 1
      max_tokens: 128
      sampling_params:
        temperature: 0.2
        top_p: 0.2
      max_model_len: 4096
      gpu_memory_utilization: 0.9
      batch_timeout_ms: 60
      async_max_concurrency: 1  # 对齐 mmmu_local_vlm，默认单并发防止多模态显存抖动

role_adapters:
  - adapter_id: mmmu_legacy_vllm_adapter
    role_type: dut_model
    backend_id: mmmu_legacy_vllm_backend
    capabilities:
      - vision_chat

metrics:
  - metric_id: mmmu_acc
    implementation: mmmu_accuracy

tasks:
  - task_id: mmmu_val_eval
    dataset_id: mmmu_val_local
    max_samples: 500
    reporting:
      sinks:
        - type: console
        - type: file
          params:
            output_path: ${GAGE_EVAL_SAVE_DIR:-./runs}/mmmu_legacy_vllm_events.jsonl
    concurrency: 1
