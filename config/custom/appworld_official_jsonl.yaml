api_version: gage/v1alpha1
kind: PipelineConfig

# Pipeline metadata used by reporting and run summaries.
metadata:
  name: appworld_official_jsonl
  description: AppWorld official JSONL evaluation via MCP + judge_extend.

# JSONL dataset source exported from the AppWorld image.
datasets:
  - dataset_id: appworld_dev
    loader: jsonl
    params:
      # Default subset is dev; update path + subset for train/test_normal/test_challenge.
      path: local-datasets/appworld/dev.jsonl
      # Missing hint shown when the JSONL file is not found.
      missing_hint: "Run: gage-eval-main/docker/appworld/export_datasets.sh --image appworld-mcp:latest --output local-datasets/appworld"
      # Normalize AppWorld records into standardized Sample objects.
      preprocess: appworld_preprocessor
      preprocess_kwargs:
        # Keep subset aligned with the dataset file.
        subset: dev
        # Use full for train/dev; test subsets auto-downgrade to minimal.
        ground_truth_mode: full
      streaming: false

backends:
  - backend_id: gpt52_openai_http
    type: openai_http
    config:
      # Use a stable OpenAI-compatible endpoint for the demo workflow.
      base_url: https://api.openai.com/v1
      model: gpt-5.2
      require_api_key: true
      max_retries: 6        

agent_backends:
  - agent_backend_id: agent_model_main
    type: model_backend
    backend_id: gpt52_openai_http
    config:
      # Force tool calls early so AppWorld actions are exercised in the demo.
      force_tool_choice: first_turn

sandbox_profiles:
  - sandbox_id: appworld_local
    # Docker-based AppWorld runtime profile.
    runtime: docker
    image: appworld-mcp:latest
    resources:
      cpu: 2
      memory: 4g
    runtime_configs:
      # Startup health checks and port wiring for AppWorld services.
      startup_timeout_s: 180
      startup_interval_s: 0.5
      ports: ["8000:8000", "9000:9000", "5001:5001"]
      # Force amd64 for Apple Silicon hosts.
      platform: linux/amd64
      network_mode: bridge_host
      # Explicit endpoints passed into AppWorld hooks and MCP clients.
      env_endpoint: http://127.0.0.1:8000
      apis_endpoint: http://127.0.0.1:9000
      mcp_endpoint: http://127.0.0.1:5001
      wait_for_http_endpoints:
        - http://127.0.0.1:5001/mcp
      # Start the container automatically for each task.
      start_container: true
      entrypoint: /usr/local/bin/appworld
      env:
        VIRTUAL_ENV: ""
        PATH: /usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin
      command:
        - serve
        - multiple
        - --environment
        - "--port 8000"
        - --apis
        - "--port 9000"
        - --mcp
        - "http --port 5001 --output-type structured_data_only"
        - --root
        - /run

mcp_clients:
  - mcp_client_id: appworld_env
    # Streamable MCP client for AppWorld tool discovery and tool calls.
    transport: streamable_http
    endpoint: http://127.0.0.1:5001
    timeout_s: 180
    params:
      output_type: structured_data_only
      session_retry_delay_s: 2
      session_retry_timeout_s: 180

metrics:
  # For test_normal/test_challenge, prefer appworld_tgc; other fields are redacted unless judge redaction is disabled.
  - metric_id: appworld_tgc
    implementation: appworld_tgc
  - metric_id: appworld_sgc
    implementation: appworld_sgc
  - metric_id: appworld_pass_count
    implementation: appworld_pass_count
  - metric_id: appworld_fail_count
    implementation: appworld_fail_count
  - metric_id: appworld_difficulty
    implementation: appworld_difficulty
    aggregation: categorical_count
    params:
      category_field: difficulty

role_adapters:
  - adapter_id: api_descriptions_context
    role_type: context_provider
    mcp_client_id: appworld_env
    params:
      implementation: appworld_api_docs
      implementation_params:
        mode: api_descriptions
        auto_discover_apps: true
        include_app_descriptions: true
        max_chars: 200000

  - adapter_id: api_predictor
    role_type: helper_model
    backend_id: gpt52_openai_http
    prompt_id: helper/appworld_api_predictor@v1
    params:
      implementation: appworld_api_predictor
      implementation_params:
        max_apis: 16
        always_include_apps:
          - api_docs
          - supervisor
        always_include_tools:
          - supervisor.complete_task

  - adapter_id: toolchain_main
    role_type: toolchain
    mcp_client_id: appworld_env
    params:
      # Disable Meta-Tools to align with AppWorld doc-first flow.
      meta_tool_mode: false
      # Keep ApiDocs-driven behavior aligned with the paper baselines.
      tool_doc_enabled: false
      # Use schema_yaml to include constraints/response schemas with truncation.
      tool_doc_format: schema_yaml
      tool_doc_max_endpoints: 60
      tool_doc_max_chars: 12000

  - adapter_id: dut_agent_main
    role_type: dut_agent
    agent_backend_id: agent_model_main
    prompt_id: dut/appworld@v1
    sandbox:
      sandbox_id: appworld_local
      # Create an isolated container per task.
      lifecycle: per_task
    params:
      # Safety net for runaway tool loops.
      max_turns: 120
      pre_hooks:
        # Initialize AppWorld task state before the agent starts.
        - type: appworld_initialize
      post_hooks:
        # Persist AppWorld task outputs after the agent finishes.
        - type: appworld_save

  - adapter_id: appworld_judge
    role_type: judge_extend
    params:
      implementation: appworld_evaluate
      implementation_params:
        # AppWorld data root inside the container.
        appworld_root: /run
        # Export container outputs to runs/<run_id>/appworld_artifacts.
        export_outputs: true

tasks:
  - task_id: appworld_dev_eval
    dataset_id: appworld_dev
    steps:
      - step: support
        adapter_id: api_descriptions_context
      - step: support
        adapter_id: api_predictor
      - step: support
        adapter_id: toolchain_main
      - step: inference
        adapter_id: dut_agent_main
      - step: judge
        adapter_id: appworld_judge
      - step: auto_eval
    # Keep concurrency low for deterministic AppWorld env usage.
    concurrency: 1
    # Smoke-test size; remove or raise for full runs.
    max_samples: 20
    reporting:
      sinks:
        - type: console
