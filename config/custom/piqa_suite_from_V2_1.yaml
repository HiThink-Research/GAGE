api_version: gage/v1alpha1

kind: PipelineConfig

metadata:
  name: piqa_qwen3
  description: 使用 Qwen3 OpenAI Chat 后端评测 PIQA validation 子集，示范外置 Prompt 与结构化预处理。

custom:
  steps:
  - step: inference
  - step: auto_eval

prompts:
- prompt_id: piqa_infer_prompt
  renderer: jinja
  params:
    system_prompt: |
      你是一位擅长常识推理的助手，请阅读题目并在最后只输出正确选项对应的大写字母（A 或 B）。
    instruction: |
      请判断哪个答案更合理，并在最后一行仅输出一个大写字母（A 或 B）。
  template: |
    {{ system_prompt }}

    题目：
    {{ sample.goal }}

    选项：
    {% for label, text in (sample.metadata.option_map or {}).items() %}
    {{ label }}. {{ text }}
    {% endfor %}

    {{ instruction }}

datasets:
- dataset_id: piqa_validation
  hub: huggingface
  hub_params:
    hub_id: piqa
    split: validation
    trust_remote_code: true
  loader: hf_hub
  params:
    preprocess: piqa_struct_only
    streaming: false

backends:
- backend_id: qwen3_openai_http
  type: openai_http
  config:
    base_url: http://127.0.0.1:1234/v1
    model: qwen2.5-0.5b-instruct
    default_params:
      max_new_tokens: 64
      temperature: 0.2
    async_max_concurrency: 4

role_adapters:
- adapter_id: dut_qwen3
  role_type: dut_model
  backend_id: qwen3_openai_http
  prompt_id: piqa_infer_prompt
  prompt_params:
    language: zh
  capabilities:
  - chat_completion

metrics:
- metric_id: piqa_acc
  implementation: multi_choice_accuracy

tasks:
- task_id: piqa_validation_eval
  dataset_id: piqa_validation
  max_samples: 500
  reporting:
    sinks:
    - type: console
    - type: file
      params:
        output_path: ${GAGE_EVAL_SAVE_DIR:-./runs}/piqa_events.jsonl
